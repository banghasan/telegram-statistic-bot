<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        <title>Telegram Stats</title>
        <script src="https://telegram.org/js/telegram-web-app.js"></script>
        <script
            defer
            src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
        ></script>
        <link rel="stylesheet" href="style.css" />
    </head>
    <body>
        <div x-data="statsApp" class="app-container">
        <div x-data="statsApp" class="app-container">
            <!-- View: Restricted Access -->
            <div
                x-show="view === 'restricted'"
                x-transition
                class="restricted-view"
            >
                <div class="restricted-content">
                    <div class="restricted-icon">ü§ñ</div>
                    <h1 class="restricted-title">Access Denied</h1>
                    <p class="restricted-text">
                        This web app can only be accessed through Telegram Bot:
                        <strong x-text="botUsername"></strong>
                    </p>
                    <a
                        :href="'https://t.me/' + botUsername"
                        target="_blank"
                        class="btn-primary"
                    >
                        Open Bot
                    </a>
                </div>
            </div>

            <!-- Loading overlay -->
            <div x-show="loading" class="loading-overlay">
                <div class="loader"></div>
            </div>

            <!-- Error Message -->
            <div x-show="error" class="error-banner" x-text="error"></div>

            <!-- Navigation (Admin Only) -->
            <template x-if="!restricted && isAdmin">
                <nav class="tab-nav">
                    <button
                        @click="view = 'stats'"
                        :class="{'active': view === 'stats'}"
                        class="tab-btn"
                    >
                        <span class="tab-icon">üìä</span>
                        <span class="tab-label">Stats</span>
                    </button>
                    <button
                        @click="loadGroups(1)"
                        :class="{'active': view === 'groups'}"
                        class="tab-btn"
                    >
                        <span class="tab-icon">üë•</span>
                        <span class="tab-label">Groups</span>
                    </button>
                    <button
                        @click="loadUsers(1)"
                        :class="{'active': view === 'users'}"
                        class="tab-btn"
                    >
                        <span class="tab-icon">üë§</span>
                        <span class="tab-label">Users</span>
                    </button>
                </nav>
            </template>

            <!-- Main Content -->
            <main class="main-content">
                <!-- View: My Stats -->
                <div x-show="view === 'stats'" x-transition class="view-container">
                    <!-- Header -->
                    <div class="header-section">
                        <h1 class="page-title">
                            Hallo <span x-text="user?.first_name || 'undefined'"></span><span x-show="user?.last_name" x-text="' ' + user?.last_name"></span>!
                        </h1>
                        <p class="page-subtitle">Here are your personal statistics</p>
                    </div>

                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-item">
                            <div class="stat-icon">üí¨</div>
                            <div class="stat-content">
                                <div class="stat-label">Messages</div>
                                <div class="stat-value" x-text="formatNumber(stats.message || 0)"></div>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon">üìù</div>
                            <div class="stat-content">
                                <div class="stat-label">Edited</div>
                                <div class="stat-value" x-text="formatNumber(stats.edited_message || 0)"></div>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon">üóëÔ∏è</div>
                            <div class="stat-content">
                                <div class="stat-label">Deleted</div>
                                <div class="stat-value" x-text="formatNumber(stats.deleted || 0)"></div>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon">üìë</div>
                            <div class="stat-content">
                                <div class="stat-label">Words</div>
                                <div class="stat-value" x-text="formatNumber(stats.words || 0)"></div>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon">üñºÔ∏è</div>
                            <div class="stat-content">
                                <div class="stat-label">Media</div>
                                <div class="stat-value" x-text="formatNumber(stats.media || 0)"></div>
                            </div>
                        </div>
                        
                        <div class="stat-item">
                            <div class="stat-icon">üòä</div>
                            <div class="stat-content">
                                <div class="stat-label">Stickers</div>
                                <div class="stat-value" x-text="formatNumber(stats.sticker || 0)"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Group Activity Section -->
                    <div class="section">
                        <h2 class="section-title">Your Group Activity</h2>
                        <div class="card table-card">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Group</th>
                                        <th class="text-right">Your Msgs</th>
                                        <th class="text-right">Last Activity</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template x-if="groupsForUser.length === 0">
                                        <tr>
                                            <td colspan="3" class="empty-cell">
                                                <div class="empty-state">
                                                    <div class="empty-icon">üì≠</div>
                                                    <div class="empty-text">No group activity found</div>
                                                </div>
                                            </td>
                                        </tr>
                                    </template>
                                    <template x-for="group in groupsForUser" :key="group.groupId">
                                        <tr>
                                            <td class="font-medium" x-text="group.title"></td>
                                            <td class="text-right" x-text="formatNumber(group.userMessageCount)"></td>
                                            <td class="text-right text-sm" x-text="formatDate(group.lastActivity)"></td>
                                        </tr>
                                    </template>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- View: Groups -->
                <div x-show="view === 'groups'" x-transition class="view-container">
                    <div class="header-section">
                        <h1 class="page-title">Top Groups</h1>
                        <p class="page-subtitle">Activity from the last 3 months</p>
                    </div>

                    <div class="card">
                        <template x-for="(group, index) in groupsList" :key="group.id">
                            <div class="list-item">
                                <div class="list-item-number" x-text="(groupsPage - 1) * 5 + index + 1"></div>
                                <div class="list-item-content">
                                    <div class="list-item-title" x-text="group.title"></div>
                                    <div class="list-item-subtitle">
                                        <span x-text="formatNumber(group.message)"></span> msgs ‚Ä¢ 
                                        <span x-text="formatNumber(group.users)"></span> users
                                    </div>
                                </div>
                                <div class="list-item-type" x-text="group.type[0].toUpperCase()"></div>
                            </div>
                        </template>
                    </div>

                    <div class="pagination">
                        <button
                            @click="loadGroups(groupsPage - 1)"
                            :disabled="groupsPage <= 1"
                            class="pagination-btn"
                        >
                            ‚Üê Prev
                        </button>
                        <span class="pagination-info" x-text="groupsPage + ' / ' + groupsTotalPages"></span>
                        <button
                            @click="loadGroups(groupsPage + 1)"
                            :disabled="groupsPage >= groupsTotalPages"
                            class="pagination-btn"
                        >
                            Next ‚Üí
                        </button>
                    </div>
                </div>

                <!-- View: Users -->
                <div x-show="view === 'users'" x-transition class="view-container">
                    <div class="header-section">
                        <h1 class="page-title">Top Users</h1>
                        <p class="page-subtitle">Most active in the last 3 months</p>
                    </div>

                    <div class="card">
                        <template x-for="(u, index) in usersList" :key="u.id">
                            <div class="list-item">
                                <div class="list-item-number" x-text="(usersPage - 1) * 5 + index + 1"></div>
                                <div class="list-item-content">
                                    <div class="list-item-title">
                                        <span x-text="u.first_name"></span>
                                        <span x-show="u.last_name" x-text="' ' + u.last_name"></span>
                                    </div>
                                    <div class="list-item-subtitle">
                                        <span x-text="formatNumber(u.message)"></span> msgs ‚Ä¢ 
                                        Avg: <span x-text="formatNumber(u.average)"></span>
                                    </div>
                                </div>
                                <div class="list-item-badge" x-text="u.last_activity || 'N/A'"></div>
                            </div>
                        </template>
                    </div>

                    <div class="pagination">
                        <button
                            @click="loadUsers(usersPage - 1)"
                            :disabled="usersPage <= 1"
                            class="pagination-btn"
                        >
                            ‚Üê Prev
                        </button>
                        <span class="pagination-info" x-text="usersPage + ' / ' + usersTotalPages"></span>
                        <button
                            @click="loadUsers(usersPage + 1)"
                            :disabled="usersPage >= usersTotalPages"
                            class="pagination-btn"
                        >
                            Next ‚Üí
                        </button>
                    </div>
                </div>
            </main>
        </div>

        <script src="script.js"></script>
    </body>
</html>
